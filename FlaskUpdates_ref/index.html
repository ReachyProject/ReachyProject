<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Reachy Visualizer - Blender Mode</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #0a0e1a;
    }
  </style>
</head>

<body>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

    // --- Scene setup (Blender coordinate system: Z-up) ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x333333);

    const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 50);
    // Position camera to face reachy head-on (reachy faces -X, so camera on +X axis)
    camera.position.set(2, 0, 1);
    camera.up.set(0, 0, 1); // Critical: set Z as up direction

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    // --- Blender-style Controls ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = true;
    
    // Blender mouse mappings:
    // Middle mouse = orbit
    // Shift + middle mouse = pan
    // Scroll = zoom
    controls.mouseButtons = {
      LEFT: null,  // Disable left click
      MIDDLE: THREE.MOUSE.ROTATE,  // Middle mouse to orbit
      RIGHT: THREE.MOUSE.PAN  // Disable right click
    };
    
    // Enable pan with Shift+Middle (OrbitControls does this automatically)
    controls.target.set(0, 0, 1); // Look at center, Z-up
    controls.update();

    // --- Lighting ---
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 5, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.3));

    // --- Grid (XY plane, since Z is up in Blender) ---
    const grid = new THREE.GridHelper(10, 20, 0x3a3a3a, 0x555555);
    // Rotate grid to XY plane (default GridHelper is in XZ)
    grid.rotation.x = Math.PI / 2;
    grid.position.z = 0;
    scene.add(grid);

    let reachy, joints = {};

    // --- Load Reachy model ---
    new GLTFLoader().load(
      "reachy.glb",
      (gltf) => {
        reachy = gltf.scene;
        
        // Create a wrapper to handle coordinate system transform
        // This keeps reachy's internal coordinate system clean
        const reachyWrapper = new THREE.Group();
        reachyWrapper.add(reachy);
        scene.add(reachyWrapper);

        // Compute and center bounding box
        const box = new THREE.Box3().setFromObject(reachy);
        const center = new THREE.Vector3();
        box.getCenter(center);
        reachyWrapper.position.sub(center);
        reachyWrapper.position.z += 1; // Lift up along Z to center in view
        reachyWrapper.position.y -= 0.15; // Lift up along Z to center in view

        // Apply the coordinate transform to the wrapper, not the model
        // This converts from Three.js import (Y-up) to Blender convention (Z-up)
        reachyWrapper.rotation.x = Math.PI / 2;

        // Gather joint references
        reachy.traverse((obj) => {
          const name = obj.name.toLowerCase();
          if (name.includes("joint")) {
            joints[name] = obj;
            // Set rotation order to match Blender
            if (obj.rotation) {
              obj.rotation.order = 'XYZ';
            }
            const axes = new THREE.AxesHelper(0.05);
            obj.add(axes);
          }
        });

        console.log("Detected joints:", Object.keys(joints));
        console.log("Reachy wrapper rotation:", reachyWrapper.rotation);
        console.log("Reachy internal rotation:", reachy.rotation);
      },
      undefined,
      (err) => console.error("Error loading Reachy model:", err)
    );

    // --- Render loop ---
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>

</html>